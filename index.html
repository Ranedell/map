<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Telegram WebApps API</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /* ваш стиль остается без изменений */
    </style>
</head>

<body>
    <div id="usercard"></div>
    <p>Место для подписи:</p>
    <p class="hint">Оставьте подпись пальцем на экране</p>
    <canvas id="drawingCanvas" width="300" height="200"></canvas>
    <button id="clearButton" class="button inactive">Очистить</button>
    <button id="saveButton" class="button inactive">Сохранить</button>
    <button id="sendButton" class="button hidden">Отправить данные</button>
</body>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    tg.MainButton.text = "Сохранить подпись";
    tg.MainButton.setText("Сохранить подпись");
    tg.MainButton.textColor = "#0000FF";
    tg.MainButton.color = "#FFFFFF";
    tg.MainButton.setParams({ "color": "#FFFFFF" });

    let isDrawing = false;
    const canvas = document.getElementById("drawingCanvas");
    const ctx = canvas.getContext("2d");
    let lastX = 0;
    let lastY = 0;

    canvas.addEventListener("mousedown", startDrawing);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mouseup", stopDrawing);
    canvas.addEventListener("mouseout", stopDrawing);
    canvas.addEventListener("touchstart", startDrawing);
    canvas.addEventListener("touchmove", draw);
    canvas.addEventListener("touchend", stopDrawing);
    canvas.addEventListener("touchcancel", stopDrawing);

    function startDrawing(e) {
        isDrawing = true;
        [lastX, lastY] = getMousePosition(e);
    }

    function draw(e) {
        if (!isDrawing) return;
        ctx.strokeStyle = "#0000FF";
        ctx.lineWidth = 2;
        ctx.lineJoin = "round";
        ctx.lineCap = "round";
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        const [x, y] = getMousePosition(e);
        ctx.lineTo(x, y);
        ctx.stroke();
        [lastX, lastY] = [x, y];
        updateButtonState();
    }

    function stopDrawing() {
        isDrawing = false;
    }

    function getMousePosition(e) {
        if (e.type.includes("touch")) {
            return [e.touches[0].clientX - canvas.getBoundingClientRect().left, e.touches[0].clientY - canvas.getBoundingClientRect().top];
        }
        return [e.offsetX, e.offsetY];
    }

    const clearButton = document.getElementById("clearButton");
    const saveButton = document.getElementById("saveButton");
    const sendButton = document.getElementById("sendButton");

    clearButton.addEventListener("click", () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        clearButton.classList.add("inactive");
        saveButton.classList.add("inactive");
        sendButton.classList.add("hidden");
    });

    let imageDataURL; // переменная для хранения изображения в формате base64

    saveButton.addEventListener("click", () => {
        saveButton.classList.add("inactive");
        clearButton.classList.add("inactive");
        sendButton.classList.remove("hidden");

        imageDataURL = canvas.toDataURL("image/png");
        updateButtonState();
    });

    sendButton.addEventListener("click", () => {
        // Отправка данных боту
        tg.sendData(imageDataURL);
    });

    function updateButtonState() {
        clearButton.classList.remove("inactive");
        saveButton.classList.remove("inactive");
    }

    Telegram.WebApp.onEvent('mainButtonClicked', function () {
        // Добавьте здесь код для обработки события нажатия на основную кнопку
    });

    let usercard = document.getElementById("usercard");

    let profName = document.createElement('p');
    profName.innerText = `${tg.initDataUnsafe.user.first_name}
   ${tg.initDataUnsafe.user.last_name}
   ${tg.initDataUnsafe.user.username} (${tg.initDataUnsafe.user.language_code})`;
    usercard.appendChild(profName);

    let userid = document.createElement('p');
    userid.innerText = `${tg.initDataUnsafe.user.id}`;
    usercard.appendChild(userid);
</script>

</html>
