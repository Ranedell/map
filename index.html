<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Test Telegram WebApps API</title>
   <script src="https://telegram.org/js/telegram-web-app.js"></script> <!--Подключаем скрипт от телеграм-->

   <style>
      body {
         color: var(--tg-theme-text-color);
         background: var(--tg-theme-bg-color);
         display: flex;
         flex-direction: column;
         align-items: center;
         font-size: 18px;
      }

      .hint {
         color: var(--tg-theme-hint-color);
      }

      .link {
         color: var(--tg-theme-link-color);
      }

      .button {
         background: var(--tg-theme-button-color);
         color: var(--tg-theme-button-text-color);
         border: none;
         font-size: 18px;
      }

      .button:not(:last-child) {
         margin-bottom: 20px
      }

      #usercard {
         text-align: center;
      }

      canvas {
         border: 2px solid #000;
      }
   </style>
</head>

<body>
   <div id="usercard"> <!--Карта профиля, человека, который к нам обратился-->
   </div>
   <p>Место для подписи:</p>
   <p class="hint">Оставьте подпись пальцем на экране</p> <!--Просто текст-подсказка для проверки-->
   <canvas id="drawingCanvas" width="300" height="200"></canvas> <!-- Canvas для рисования -->
   <button id="clearButton" class="button">Очистить</button> <!-- Кнопка для очистки -->
   <button id="saveButton" class="button" disabled>Сохранить</button> <!-- Кнопка для сохранения -->
   <button id="sendButton" class="button" disabled>Отправить данные</button> <!-- Кнопка для отправки данных -->

   <script>
      let tg = window.Telegram.WebApp; //получаем объект webapp телеграма 

      tg.expand(); //расширяем на все окно  

      tg.MainButton.text = "Отправить данные"; //изменяем текст кнопки 
      tg.MainButton.setText("Отправить данные"); //изменяем текст кнопки иначе
      tg.MainButton.textColor = "#F55353"; //изменяем цвет текста кнопки
      tg.MainButton.color = "#143F6B"; //изменяем цвет бэкграунда кнопки
      tg.MainButton.setParams({"color": "#143F6B"}); //так изменяются все параметры

      let saveButton = document.getElementById("saveButton"); //получаем кнопку сохранить
      let sendButton = document.getElementById("sendButton"); //получаем кнопку отправить
      let clearButton = document.getElementById("clearButton"); //получаем кнопку очистить

      // Получаем ссылку на Canvas и контекст
      const canvas = document.getElementById("drawingCanvas");
      const ctx = canvas.getContext("2d");

      // Переменная, чтобы определить, начал ли пользователь рисовать
      let isDrawing = false;

      // Начальные координаты и цвет линии
      let lastX = 0;
      let lastY = 0;

      // При нажатии на Canvas начинаем рисовать
      canvas.addEventListener("touchstart", (e) => {
         isDrawing = true;
         [lastX, lastY] = [e.touches[0].clientX, e.touches[0].clientY];
      });

      // При движении пальцем рисуем
      canvas.addEventListener("touchmove", draw);

      // При отпускании пальца прекращаем рисовать
      canvas.addEventListener("touchend", () => isDrawing = false);

      function draw(e) {
         if (!isDrawing) return; // Прекращаем функцию, если пользователь не рисует
         ctx.strokeStyle = `blue`; // Устанавливаем цвет линии
         ctx.lineWidth = 5; // Толщина линии
         ctx.lineJoin = "round";
         ctx.lineCap = "round";
         ctx.beginPath();
         ctx.moveTo(lastX, lastY); // Перемещаемся к последним координатам
         ctx.lineTo(e.touches[0].clientX, e.touches[0].clientY); // Рисуем линию к новым координатам
         ctx.stroke();
         [lastX, lastY] = [e.touches[0].clientX, e.touches[0].clientY]; // Обновляем координаты
         // Разрешаем кнопку "Сохранить" после того, как пользователь начал рисовать
         saveButton.disabled = false;
      }

      // Кнопка "Очистить"
      clearButton.addEventListener("click", () => {
         ctx.clearRect(0, 0, canvas.width, canvas.height); // Очищаем Canvas
         // Запрещаем кнопки "Сохранить" и "Отправить данные"
         saveButton.disabled = true;
         sendButton.disabled = true;
      });

      // Кнопка "Сохранить"
      saveButton.addEventListener("click", () => {
         const dataURL = canvas.toDataURL("image/png"); // Преобразуем Canvas в изображение
         // Сохраняем данные в localStorage, чтобы передать их при нажатии "Отправить данные"
         localStorage.setItem("signatureData", dataURL);
         // Разрешаем кнопку "Отправить данные" после сохранения изображения
         sendButton.disabled = false;
      });

      // Кнопка "Отправить данные"
      sendButton.addEventListener("click", () => {
         // Получаем сохраненные данные из localStorage
         const dataURL = localStorage.getItem("signatureData");
         // Очищаем localStorage
         localStorage.removeItem("signatureData");
         // Отправляем данные боту
         tg.sendData(dataURL);
      });

      let usercard = document.getElementById("usercard"); //получаем блок usercard 

      let profName = document.createElement('p'); //создаем параграф
      profName.innerText = `${tg.initDataUnsafe.user.first_name}
      ${tg.initDataUnsafe.user.last_name}
      ${tg.initDataUnsafe.user.username} (${tg.initDataUnsafe.user.language_code})`;
      //выдем имя, "фамилию", через тире username и код языка
      usercard.appendChild(profName); //добавляем 

      let userid = document.createElement('p'); //создаем еще параграф 
      userid.innerText = `${tg.initDataUnsafe.user.id}`; //показываем user_id
      usercard.appendChild(userid); //добавляем
   </script>
</body>
</html>
